#!/bin/bash

# Package Manager Enforcement Pre-commit Hook
# Enforces yarn usage and prevents npm package-lock.json conflicts

set -e

echo "üîç Checking package manager enforcement..."

# Colors for output (disable if not in a terminal)
if [ -t 1 ]; then
    RED='\033[0;31m'
    YELLOW='\033[1;33m'
    GREEN='\033[0;32m'
    BLUE='\033[0;34m'
    NC='\033[0m' # No Color
else
    RED=''
    YELLOW=''
    GREEN=''
    BLUE=''
    NC=''
fi

# Function to print educational error messages
print_error() {
    printf "${RED}‚ùå %s${NC}\n" "$1"
}

print_warning() {
    printf "${YELLOW}‚ö†Ô∏è  %s${NC}\n" "$1"
}

print_success() {
    printf "${GREEN}‚úÖ %s${NC}\n" "$1"
}

print_info() {
    printf "${BLUE}‚ÑπÔ∏è  %s${NC}\n" "$1"
}

# Track if any errors were found
HAS_ERRORS=false

# 1. Check for package-lock.json files
echo
print_info "üîç Checking for package-lock.json files..."
if find . -name "package-lock.json" -not -path "./node_modules/*" | grep -q "package-lock.json"; then
    print_error "package-lock.json files detected in the repository!"
    echo
    print_info "This project uses Yarn as the package manager. package-lock.json files"
    print_info "are created by npm and can cause dependency conflicts."
    echo
    print_info "To fix this issue:"
    echo "  1. Remove the package-lock.json file(s):"
    find . -name "package-lock.json" -not -path "./node_modules/*" | while read -r file; do
        echo "     rm \"$file\""
    done
    echo "  2. Use 'yarn install' instead of 'npm install'"
    echo "  3. Use 'yarn add <package>' instead of 'npm install <package>'"
    echo
    HAS_ERRORS=true
else
    print_success "No package-lock.json files found"
fi

# 2. Check for npm commands in package.json scripts
echo
print_info "üîç Checking for npm commands in package.json scripts..."
NPM_SCRIPTS_FOUND=false

for package_file in $(find . -name "package.json" -not -path "./node_modules/*"); do
    if grep -q '"scripts"' "$package_file"; then
        # Extract scripts section and check for npm commands
        if grep -A 50 '"scripts"' "$package_file" | grep -E '"[^"]*":\s*"[^"]*npm[^"]*"' | grep -q -v yarn; then
            print_warning "Found npm commands in $package_file scripts"
            echo
            print_info "Consider replacing npm commands with yarn equivalents:"
            echo "  npm install        ‚Üí yarn install"
            echo "  npm install <pkg>  ‚Üí yarn add <pkg>"
            echo "  npm run <script>   ‚Üí yarn <script>"
            echo "  npm test           ‚Üí yarn test"
            echo "  npm start          ‚Üí yarn start"
            echo "  npm run build      ‚Üí yarn build"
            echo
            NPM_SCRIPTS_FOUND=true
        fi
    fi
done

if [ "$NPM_SCRIPTS_FOUND" = false ]; then
    print_success "No npm commands found in package.json scripts"
fi

# 3. Check that yarn.lock exists when package.json has dependencies
echo
print_info "üîç Checking yarn.lock consistency..."
PACKAGE_JSON_WITH_DEPS=false

# Check if any package.json files have dependencies
for package_file in $(find . -name "package.json" -not -path "./node_modules/*"); do
    if grep -q '"dependencies"\|"devDependencies"' "$package_file"; then
        PACKAGE_JSON_WITH_DEPS=true
        break
    fi
done

if [ "$PACKAGE_JSON_WITH_DEPS" = true ]; then
    if [ ! -f "./yarn.lock" ]; then
        print_error "yarn.lock file is missing but package.json files have dependencies!"
        echo
        print_info "To fix this issue:"
        echo "  1. Run 'yarn install' to generate yarn.lock"
        echo "  2. Commit the yarn.lock file to ensure consistent dependency resolution"
        echo
        HAS_ERRORS=true
    else
        print_success "yarn.lock file exists"
    fi
else
    print_info "No dependencies found in package.json files"
fi

# 4. Check for branch synchronization issues (especially for GitHub Copilot agents)
echo
print_info "üîÑ Checking branch synchronization..."

# Check if we're on a feature branch and if yarn.lock differs from main
if command -v git >/dev/null 2>&1; then
    CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
    
    if [ "$CURRENT_BRANCH" != "main" ] && [ "$CURRENT_BRANCH" != "unknown" ]; then
        # Check if yarn.lock exists and differs from main
        if [ -f "./yarn.lock" ] && git show main:yarn.lock >/dev/null 2>&1; then
            if ! git diff --quiet main HEAD -- yarn.lock 2>/dev/null; then
                print_info "üìã Branch '$CURRENT_BRANCH' has yarn.lock differences from main"
                echo "  This is normal if you've added dependencies, but ensure you're building"
                echo "  on the latest infrastructure by running: git rebase origin/main"
            fi
        fi
    fi
fi

# 5. Performance check - ensure hook runs quickly
HOOK_END_TIME=$(date +%s%N)
HOOK_START_TIME=${HOOK_START_TIME:-$HOOK_END_TIME}
HOOK_DURATION=$((($HOOK_END_TIME - $HOOK_START_TIME) / 1000000)) # Convert to milliseconds

# Only show timing if it took more than 100ms or if explicitly requested
if [ $HOOK_DURATION -gt 100 ] || [ "${SHOW_TIMING}" = "true" ]; then
    print_info "Hook execution time: ${HOOK_DURATION}ms"
fi

# Final result
if [ "$HAS_ERRORS" = true ]; then
    echo
    print_error "Pre-commit hook failed! Please fix the issues above before committing."
    echo
    print_info "This hook enforces yarn usage to prevent package manager conflicts."
    print_info "For more information, see the project's CONTRIBUTING.md file."
    echo
    print_info "üí° GitHub Copilot Agent Tip:"
    echo "  If your branch is behind main and yarn.lock has been updated:"
    echo "  1. Sync your branch with main: git rebase origin/main"
    echo "  2. Run yarn install to update dependencies"
    echo "  3. Commit any yarn.lock changes before implementing features"
    echo "  4. This ensures your implementation builds on the latest infrastructure"
    exit 1
else
    echo
    print_success "Package manager enforcement checks passed!"
fi
