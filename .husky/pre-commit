#!/usr/bin/env sh
# Pre-commit hook for shmup-yours
# Integrates with educational error message system in .github/hooks/

. "$(dirname -- "$0")/_/husky.sh"

# Source the error message functions
source "$(git rev-parse --show-toplevel)/.github/hooks/error-messages.sh" 2>/dev/null || {
    echo "Warning: Error message templates not found"
}

# Performance tracking
start_time=$(date +%s)

echo "🔍 Running pre-commit quality checks..."

# Check for package manager consistency
if [ -f "package-lock.json" ]; then
    echo ""
    show_package_manager_error "npm" "yarn" "$(pwd)"
    exit 1
fi

# Run lint-staged for performance (only staged files)
echo "📝 Checking code style (ESLint)..."
yarn lint:staged

# Check exit code and provide educational feedback
lint_exit_code=$?
if [ $lint_exit_code -ne 0 ]; then
    echo ""
    # Try to determine the type of ESLint error
    if ! command -v eslint >/dev/null 2>&1; then
        show_eslint_error "configuration" "ESLint not installed" ""
    else
        # Check if it's a configuration issue
        eslint --print-config package.json >/dev/null 2>&1
        config_exit=$?
        if [ $config_exit -ne 0 ]; then
            show_eslint_error "configuration" "Invalid ESLint configuration" ""
        else
            show_eslint_error "violations" "Code style violations detected" "staged files"
        fi
    fi
    
    echo ""
    echo "💡 Quick fixes to try:"
    echo "   yarn lint:fix           # Auto-fix many issues"
    echo "   yarn workspace frontend lint:fix"
    echo "   yarn workspace backend lint:fix"
    echo ""
    echo "🆘 Emergency override (use sparingly):"
    echo "   git commit --no-verify  # Bypasses all hooks"
    echo ""
    
    exit 1
fi

# Performance check
end_time=$(date +%s)
duration=$((end_time - start_time))

if [ $duration -gt 30 ]; then
    echo ""
    show_performance_error "timeout" "${duration}s" "30s"
    echo ""
    echo "💡 Performance tips:"
    echo "   - ESLint cache is enabled"
    echo "   - Only staged files are checked" 
    echo "   - Consider .eslintignore for large files"
    echo ""
fi

echo "✅ All pre-commit checks passed! (${duration}s)"
echo ""